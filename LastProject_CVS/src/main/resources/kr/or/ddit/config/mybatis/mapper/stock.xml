<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stock">


<!-- 재고를 생성 -->
<!-- 	아 이 디 : insertStock
  		반 환 값 : int
  		매개변수 : Map(mem_id, 날짜)
  		설    명 : stock 추가
  		작 성 자 : 한수정
  		일    시 : 2018-09-17     
	-->
<insert id="insertStock" parameterType="stockVo">
	INSERT into stock(  stock_id  ,
						mem_id    ,
						stock_info,
						stock_date,
						stock_kind  
					 ) 	
			   VALUES( 
						#{stock_id  },
						#{mem_id    },
						#{stock_info},
						#{stock_date},
						#{stock_kind}  
					 )
 </insert>
 
 
<!-- 재고리스트를 생성 -->
<!-- 	아 이 디 : insertStockList
  		반 환 값 : int
  		매개변수 : stockListVo
  		설    명 : stockList 추가
  		작 성 자 : 한수정
  		일    시 : 2018-09-17     
	-->
	
<insert id="insertStockList" parameterType="stockListVo">
	INSERT INTO STOCK_LIST(  bcd_id    ,
						stcklist_amount,
						stcklist_exdate,
						stck_date      ,
						stcklist_info  ,
						stcklist_kind  ,
						stock_id       ,
						splylist_id    ,
						prod_id   
					 ) 	
			   VALUES(  #{bcd_id         },
						#{stcklist_amount},
						#{stcklist_exdate},
						#{stck_date      },
					    #{stcklist_info  },
					    #{stcklist_kind  },
					    #{stock_id       },
					    #{splylist_id    },					
					    #{prod_id    }					
					 )
 </insert>
 
 
<!-- 재고리스트 업데이트 -->
<!-- 	아 이 디 : updateStockList
  		반 환 값 : int
  		매개변수 : stockListVo
  		설    명 : stockList 업데이트
  		작 성 자 : 한수정
  		일    시 : 2018-09-18     
	-->
 <update id="updateStockList" parameterType="stockListVo">
 
 	UPDATE STOCK_LIST SET   
						 stcklist_amount = #{stcklist_amount }
						,stcklist_exdate = #{stcklist_exdate }
						,stck_date       = #{stck_date       }
						,stcklist_info   = #{stcklist_info   }
						,stcklist_kind   = #{stcklist_kind   }
						,stock_id        = #{stock_id        }
						,splylist_id     = #{splylist_id     }
						,prod_id         = #{prod_id         }
					    
 			   WHERE bcd_id =  #{bcd_id         }	
				 
 </update>
 


<!-- 재고 조회 -->
<!-- 	아 이 디 : getStock
	  		반 환 값 : stockVo
	  		매개변수 : Map(mem_id, 오늘날짜)
	  		설    명 : 재고 조회
	  		작 성 자 : 김현경
	  		일    시 : 2018-09-10     
-->
<select id="getStock" parameterType="Map" resultType="stockVo">
	select * 
	from stock 
	where mem_id=#{mem_id} and to_char(stock_date,'yyyyMMdd') = #{stock_date}
</select>




<!-- 	아 이 디 : getAllStock
	  		반 환 값 : stockVo
	  		매개변수 : mem_id
	  		설    명 : 전체날짜 재고리스트 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-17     
-->
<select id="getAllStock" parameterType="String" resultType="stockVo">
	select * 
	from stock 
	where mem_id=#{mem_id}
</select>


<!-- 	아 이 디 : getStockListByBcdID
	  		반 환 값 : stockListVo
	  		매개변수 : bcd_id
	  		설    명 : bcd_id 로 재고리스트(1건) 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-18     
-->
<select id="getStockListByBcdID" parameterType="String" resultType="stockListVo">
	select * 
	from stock_list 
	where bcd_id=#{bcd_id}
</select>

<!-- 	아 이 디 : getStockListByAttr
	  		반 환 값 : presentStockListVo
	  		매개변수 : map(검색컬럼 , 검색값)
	  		설    명 : 현재고 리스트 지정한 값으로 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-21     
	 -->
<select id="getStockListByAttr" parameterType="Map" resultType="presentStockListVo">
	SELECT a.prod_id, 
		   a.prod_name,
		   a.prod_price,
		   a.event_id,  
		   b.supply_date, 
		   c.splylist_id, 
		   c.stcklist_exdate, 		
		   c.stcklist_amount, 
	       c.bcd_id
	FROM prod a, supply b, stock_list c
	WHERE ${cul} = #{param} AND c.prod_id = a.prod_id AND b.supply_state = '12'
</select>

	
<!-- 편의점의 현재고 리스트 조회 -->
<!-- 	아 이 디 : getStockList
	  		반 환 값 : presentStockListVo
	  		매개변수 : String(재고코드)
	  		설    명 : 편의점의 현재고 리스트 조회
	  		작 성 자 : 김현경
	  		일    시 : 2018-09-10     
	 -->
<select id="getStockList" parameterType="String" resultType="presentStockListVo">
	SELECT a.prod_id, a.prod_name, b.supply_date, c.stcklist_exdate, a.prod_price, c.stcklist_amount, a.event_id, c.bcd_id
	FROM prod a, supply b, stock_list c
	WHERE c.stock_id = #{stock_id} AND c.prod_id = a.prod_id AND b.supply_state = '12'
</select>

<!-- 재고 상품 조회 -->
<!-- 	아 이 디 : getStockProd
	  		반 환 값 : presentStockListVo
	  		매개변수 : String(제품바코드)
	  		설    명 : 재고 상품 조회
	  		작 성 자 : 김현경
	  		일    시 : 2018-09-10     
	 -->
	 
<select id="getStockProd" parameterType="String" resultType="presentStockListVo">
	SELECT a.prod_id, a.prod_name, b.supply_date, c.stcklist_exdate, a.prod_price, c.stcklist_amount, a.event_id, c.bcd_id
	FROM prod a, supply b, stock_list c
	WHERE a.prod_id =#{prod_id} and c.prod_id = a.prod_id AND b.supply_state = '12'
</select>


<!-- 바코드조회한 상품 조회 -->
<!-- 	아 이 디 : getBarcodeProd
	  		반 환 값 : presentStockListVo
	  		매개변수 : String(재고바코드)
	  		설    명 : 재고 상품 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-12     
	 -->	 
<select id="getBarcodeProd" parameterType="String" resultType="presentStockListVo">
	SELECT a.prod_id, a.prod_name, b.supply_date, c.stcklist_exdate, a.prod_price, c.stcklist_amount, a.event_id, c.bcd_id
	FROM prod a, supply b, stock_list c
	WHERE c.bcd_id =#{bcd_id} and c.prod_id = a.prod_id AND b.supply_state = '12'
</select>


<!-- stock_id 로 stockList 조회 -->
<!-- 	아 이 디 : getStockListByStockID
	  		반 환 값 : presentStockListVo
	  		매개변수 : String(stockID)
	  		설    명 : 편의점의 현 재고 리스트 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-17     
	 -->
<select id="getStockListByStockID" parameterType="String" resultType="presentStockListVo">
	SELECT a.prod_id, a.prod_name, b.supply_date, c.stcklist_exdate, a.prod_price, c.stcklist_amount, a.event_id, c.bcd_id
	FROM prod a, supply b, stock_list c
	WHERE c.stock_id = #{stock_id} AND c.prod_id = a.prod_id AND b.supply_state = '12'
</select>



<!-- mem_id 로 재고리스트 조회 -->
<!-- 	아 이 디 : getStockListByMemId
	  		반 환 값 : presentStockListVo
	  		매개변수 : String(mem_id)
	  		설    명 : 해당 편의점 id의 최근재고 조회
	  		작 성 자 : 한수정
	  		일    시 : 2018-09-19    
	 -->
<select id="getStockListByMemId" parameterType="String" resultType="presentStockListVo">
	SELECT  a.prod_id,      
	        a.prod_name,
	        a.prod_price,
	        a.event_id,
	        b.supply_date,
	        c.bcd_id,
	        c.stcklist_exdate,
	        c.stcklist_amount		
	FROM  prod a, supply b, stock_list c
	WHERE b.supply_state = '12' AND 
	      c.prod_id = a.prod_id AND 
	      c.stock_id= (SELECT stock_id
	                   FROM (SELECT stock_id,
	                             	rank() over (partition by mem_id order by stock_date desc) rnk
	                         FROM stock
	                         WHERE mem_id=#{mem_id}) 
	                    WHERE rnk = 1)

</select>






</mapper>