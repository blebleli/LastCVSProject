<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">	
	<!-- 게시판 페이징 기법 -->
	<select id="getBoardPageList2" parameterType="String" resultType="boardVo">	
		SELECT * FROM (
			SELECT ROWNUM tot_cnt, T.*
					FROM  (
					        SELECT    (SELECT prod_name FROM prod WHERE board.prod_id = prod.prod_id) AS prod_name
									, (SELECT mem_name FROM member WHERE board.mem_id = member.mem_id) AS mem_name
									, bd_title
									, bd_rating
									, TO_CHAR(bd_date,'YY-MM-DD') as bd_date
									, mem_id
									, bd_kind_id
									, prod_id
									, bd_id
									, bd_del
							FROM BOARD
							WHERE 1=1
			                <if test="_parameter != null and _parameter != ''">
			                AND bd_kind_id = #{_parameter}		                
			                </if>
							ORDER BY bd_date DESC
			      		) T )
	</select>
	
	<!-- 게시글 작성 (공지사항 / 이벤트)-->
	<insert id="setInsertBoard" parameterType="boardVo">
		INSERT INTO BOARD (   bd_id
							, bd_title
							, bd_content
							, bd_date
							, bd_del
							, bd_views
							, bd_group
							, mem_id
							, bd_parent
							, bd_kind_id
						  )
					VALUES (  #{bd_id}
					 		, #{bd_title}
					 		, RAWTOHEX(#{bd_content})
					 		, TO_DATE(SYSDATE,#{bd_date})
					 		, #{bd_del}
					 		, #{bd_views}
					 		, #{bd_group}
					 		, #{mem_id}
					 		, #{bd_parent}
					 		, #{bd_kind_id}
					 		)
	</insert>
	
	<!-- 관리자 - 게시글 수정 -->
  	<update id="boardUpdate" parameterType="boardVo">
  		UPDATE board SET bd_title = #{bd_title}
  						,bd_content = RAWTOHEX(#{bd_content})
  		WHERE bd_id = #{bd_id}
  	</update>
  	
  	<!-- 관리자 - 게시글 삭제 -->
  	<update id="boardDelete" parameterType="String">
  		UPDATE board SET bd_del='Y' WHERE bd_id = #{bd_id}
  	</update>
	
	<!-- 게시글 상세조회 --> <!-- 게시글 수정화면 이동 -->
  	<select id="getBoard" parameterType="String" resultType="boardVo">
		SELECT	  bd_id
		 		, bd_title
		 		, UTL_RAW.CAST_TO_VARCHAR2(bd_content) as bd_content
		 		, TO_CHAR(bd_date,'YY-MM-DD') AS bd_date
		 		, bd_del
		 		, bd_rating
		 		, bd_views
		 		, bd_group
		 		, mem_id
		 		, bd_parent
		 		, bd_kind_id
		FROM board
		WHERE bd_id=#{bd_id}
  	</select>
	
	<!-- 공지사항 게시글 전체 조회 -->
	<select id="getListBoard" resultType="boardVo">
		SELECT bd_id, bd_title, UTL_RAW.CAST_TO_VARCHAR2(BD_CONTENT), bd_date, bd_del, bd_rating, bd_views,
			   bd_group, prod_id, mem_id, bd_parent, bd_kind_id
		FROM board WHERE bd_kind_id ='44'
		ORDER BY BD_DATE DESC
	</select>
	
	<update id="updateBoardView" parameterType="String">
		update board set BD_VIEWS = BD_VIEWS+1 where bd_id = (SELECT bd_id
		FROM board
		WHERE BD_ID = #{BD_ID})
	</update>  	
  	
  	
  	
  	
  	
  <!-- ======================================================================================================================= --> 	
  	
  	<!-- 리뷰 작성 -->
  	<insert id="insertReview" parameterType="boardVo">
  		INSERT INTO board (bd_id, 
  						   bd_content, 
  						   bd_title,
  						   bd_date,
  						   bd_del,
  						   bd_rating,
  						   prod_id,
  						   mem_id,
  						   bd_kind_id,
  						   bd_views)
		VALUES(#{bd_id},
				RAWTOHEX(#{bd_content}),
				SUBSTR(#{bd_content},1,4),
				sysdate,
				#{bd_del},
				#{bd_rating},
				#{prod_id},
				#{mem_id},
				'55',
				0)
  	</insert>
  	
  	<!-- 리뷰 조회 -->
  	<select id="getReviewOfProd" parameterType="String" resultType="reviewVo">
  		SELECT a.bd_id, a.bd_title, UTL_RAW.CAST_TO_VARCHAR2(bd_content) AS bd_content, a.bd_date, a.bd_del, a.bd_rating, a.bd_views,
			a.bd_group, a.prod_id, a.mem_id, a.bd_parent, a.bd_kind_id , b.mem_name
			FROM board a, member b
			WHERE prod_id = #{prod_id} AND a.mem_id = b.mem_id
  	</select>
  		  	
  	<select id="getBestProdReview" parameterType="String" resultType="boardVo" >	
  	 SELECT *FROM ( SELECT bd_id, bd_title, bd_date, bd_del, bd_rating, bd_views,prod_id, mem_id, bd_kind_id
           FROM BOARD
           WHERE bd_kind_id = '55'
           ORDER BY bd_views DESC
		)where ROWNUM &lt;=3
	</select>
	
	<!-- 메인 리뷰 top3 -->
	<select id="getReviewTop3" resultType="mainReviewsVo">
	
		SELECT    
	            P.PROD_ID
	           ,P.FILE_PATH
	           ,P.FILE_UPNAME
	           ,B.BD_ID
	           ,B.BD_TITLE
	           ,SUBSTR(UTL_RAW.CAST_TO_VARCHAR2(B.BD_CONTENT),0,30) AS BD_CONTENT
	           ,B.BD_DATE
	           ,B.BD_VIEWS
	           ,B.BD_KIND_ID
	           ,b.BD_RATING
	    FROM BOARD B
	    JOIN PROD P
	    ON B.PROD_ID = P.PROD_ID
	    WHERE B.BD_KIND_ID = '55'
	      AND B.BD_VIEWS != 0
	      AND  ROWNUM &lt; 4
	    ORDER  BY B.BD_VIEWS DESC
	</select>
  	
 <!-- ======================================================== 보 류 ================================================================== -->

  	<!-- 게시판 페이징 기법 -->
	<select id="getBoardPageList" parameterType="map" resultType="boardVo">	
		SELECT * FROM (
			SELECT ROWNUM tot_cnt, T.*
					FROM  (
					        SELECT   (SELECT mem_name FROM member WHERE board.mem_id = member.mem_id) AS mem_name
									, bd_title
									, bd_rating
									, TO_CHAR(bd_date,'YY-MM-DD') as bd_date
									, mem_id
									, bd_kind_id
									, prod_id
									, bd_id
									, bd_del
							FROM BOARD
							WHERE bd_kind_id = #{bd_kind_id}
							ORDER BY bd_date DESC
			      		) T ) WHERE tot_cnt BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}
	</select>
		
  	<!-- 게시글 전체 건수 -->
  	<select id="getWriteTotCnt" parameterType="String" resultType="int">
		SELECT count(*) FROM BOARD WHERE bd_kind_id = #{bd_kind_id}
  	</select>
</mapper>