<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
	<!-- 공지사항 게시글 생성 -->
	<insert id="setInsertBoard" parameterType="boardVo">
		INSERT INTO board (bd_id, bd_title, bd_content, bd_date, bd_del, bd_rating, bd_views,
							bd_group, prod_id, mem_id, bd_kind_id)
		VALUES (
				 #{bd_id}
				,#{bd_title}
				,RAWTOHEX(#{bd_content})
				,sysdate
				,#{bd_del}
				,#{bd_rating}
				,#{bd_views}
				,#{bd_group}
				,#{prod_id}
				,#{mem_id}
				,'44'
				)
	</insert>
	
	<!-- 공지사항 게시글 전체 조회 -->
	<select id="getListBoard" resultType="boardVo">
		SELECT bd_id, bd_title, UTL_RAW.CAST_TO_VARCHAR2(BD_CONTENT), bd_date, bd_del, bd_rating, bd_views,
			   bd_group, prod_id, mem_id, bd_parent, bd_kind_id
		FROM board WHERE bd_kind_id ='44'
		ORDER BY BD_DATE DESC
	</select>
	
	<update id="updateBoardView" parameterType="String">
		update board set BD_VIEWS = BD_VIEWS+1 where bd_id = (SELECT bd_id
		FROM board
		WHERE BD_ID = #{BD_ID})
	</update>
	
	<!-- 공지사항 게시글 상세조회 -->
	<select id="getBoard" parameterType="String" resultType="boardVo" >
			SELECT bd_id, bd_title, UTL_RAW.CAST_TO_VARCHAR2(bd_content), bd_date, bd_del, bd_rating, bd_views,
			bd_group, prod_id, mem_id, bd_parent, bd_kind_id
			FROM board
			WHERE BD_ID = #{BD_ID}
			ORDER BY BD_DATE DESC
	</select>
	
	<!-- 공지사항 게시판 정보 페이징 조회 -->
	<select id="getBoardPageList" parameterType="map" resultType="boardVo">  	
		SELECT *
		FROM (SELECT a.*, ROWNUM rn
			  FROM
				  (SELECT bd_id, lpad('    ', level*4, '    ')|| board.bd_title as bd_title,
				  		  mem_id, bd_date, bd_parent, bd_group, bd_del, bd_kind_id
				   FROM board
				   WHERE bd_kind_id='44' start with bd_parent is null connect by prior bd_id = bd_parent
				   		 order siblings by bd_date DESC, bd_group)
			  a )
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}
		ORDER BY BD_DATE DESC
	</select>
	
	<!-- 공지사항 전체 건수 -->
  	<select id="getWriteTotCnt" resultType="int">
		SELECT count(*) FROM board WHERE bd_kind_id='44'
  	</select>
  	
  	<!-- 리뷰 작성 -->
  	<insert id="insertReview" parameterType="boardVo">
  		INSERT INTO board (bd_id, 
  						   bd_content, 
  						   bd_title,
  						   bd_date,
  						   bd_del,
  						   bd_rating,
  						   prod_id,
  						   mem_id,
  						   bd_kind_id,
  						   bd_views)
		VALUES(#{bd_id},
				RAWTOHEX(#{bd_content}),
				SUBSTR(#{bd_content},1,4),
				sysdate,
				#{bd_del},
				#{bd_rating},
				#{prod_id},
				#{mem_id},
				'55',
				0)
  	</insert>
  	
  	<!-- 리뷰 조회 -->
  	<select id="getReviewOfProd" parameterType="String" resultType="reviewVo">
  		SELECT a.bd_id, a.bd_title, UTL_RAW.CAST_TO_VARCHAR2(bd_content) AS bd_content, a.bd_date, a.bd_del, a.bd_rating, a.bd_views,
			a.bd_group, a.prod_id, a.mem_id, a.bd_parent, a.bd_kind_id , b.mem_name
			FROM board a, member b
			WHERE prod_id = #{prod_id} AND a.mem_id = b.mem_id
  	</select>
  		  	
  	<select id="getBestProdReview" parameterType="String" resultType="boardVo" >	
  	 SELECT *FROM ( SELECT bd_id, bd_title, bd_date, bd_del, bd_rating, bd_views,prod_id, mem_id, bd_kind_id
           FROM BOARD
           WHERE bd_kind_id = '55'
           ORDER BY bd_views DESC
		)where ROWNUM &lt;=3
	</select>
	
	<!--  -->
	<select id="getReviewTop3" resultType="mainReviewsVo">
	
		SELECT    
	            P.PROD_ID
	           ,P.FILE_PATH
	           ,P.FILE_UPNAME
	           ,B.BD_ID
	           ,B.BD_TITLE
	           ,SUBSTR(UTL_RAW.CAST_TO_VARCHAR2(B.BD_CONTENT),0,30) AS BD_CONTENT
	           ,B.BD_DATE
	           ,B.BD_VIEWS
	           ,B.BD_KIND_ID
	           ,b.BD_RATING
	    FROM BOARD B
	    JOIN PROD P
	    ON B.PROD_ID = P.PROD_ID
	    WHERE B.BD_KIND_ID = '55'
	      AND B.BD_VIEWS != 0
	      AND  ROWNUM &lt; 4
	    ORDER  BY B.BD_VIEWS DESC
	</select>
  	
</mapper>