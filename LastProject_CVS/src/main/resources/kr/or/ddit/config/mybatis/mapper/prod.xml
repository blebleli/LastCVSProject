<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="prod">

<!-- 카테고리 별 제품 리스트 조회  -->
<select id="getCtgyProdList" parameterType="Map" resultType="prodVo">
	SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
					WHERE ${pr_class}=#{pr_class_id})
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>

<!-- 카테고리 별 제품의 갯수  -->
<select id="getCtgyProdCount" parameterType="Map" resultType="Integer">
	select count(*) 
	from prod
	where ${pr_class} = #{pr_class_id}
	
</select>

<!-- 	아 이 디 : getProd
  		반 환 값 : 
  		매개변수 : 상품 코드
  		설    명 : 제품아이디로 제품 조회
  		작 성 자 : 조종원
  		일    시 : 2018-09-12    
-->
<select id = "getProd" parameterType="String" resultType="prodVo">
	   SELECT  P.PROD_ID     
          ,P.PROD_NAME   
          ,P.PROD_INTRO  
          ,P.PROD_INFO   
          ,P.PROD_PRICE  
          ,P.PROD_EXNUM  
          ,(SELECT CTGY_NAME FROM CATEGORY WHERE CTGY_ID = P.PR_CLASS_LG )  AS PR_CLASS_LG
          ,(SELECT CTGY_NAME FROM CATEGORY WHERE CTGY_ID = P.PR_CLASS_MD )  AS PR_CLASS_MD
          ,P.EVENT_ID    
          ,P.FILE_PATH   
          ,P.FILE_UPNAME
          ,( SELECT NVL(AVG(BD_RATING),1) FROM BOARD WHERE PROD_ID = P.PROD_ID ) AS BD_RATING
     FROM  PROD P
     WHERE P.PROD_ID =#{prod_id}
</select>

<!-- 전체 행사 상품 조회 -->
<select id="getAllEventProd" parameterType="Map" resultType="prodVo">
	SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
					WHERE event_id !='200')
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>
<!-- 카테고리별 행사 상품 조회 -->
<select id="getCgEventProd" parameterType="Map" resultType="prodVo">
	SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
					WHERE event_id !='200'
					AND ${pr_class}=#{pr_class_id})
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>

<!-- 행사종류별  전체상품 조회 -->
<select id="getEventProd" parameterType="Map" resultType="prodVo">
	SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
					WHERE event_id =#{event_id})
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>

<!-- 행사종류 및 카테고리별  상품 조회 -->
<select id="getEventCtgyProd" parameterType="Map" resultType="prodVo">
	SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
					WHERE ${pr_class}=#{pr_class_id} and
						  event_id =#{event_id})
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>

<!-- 전체 상품 조회 -->
<select id="getAllProd" parameterType="Map" resultType="prodVo" >
SELECT * 
		FROM
			(SELECT a.*,ROWNUM rn 
				FROM
				(SELECT prod.*
					FROM prod
					ORDER BY prod_name)a
          )
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}
</select>



<!-- parameter: 카테고리 평점평균순으로  -->
<select id="getListProdBestCategory" parameterType="Map" resultType="prodVo">
SELECT * FROM
   (SELECT a.*, ROWNUM rn FROM
        (SELECT TBL0.* FROM
            (SELECT P.PROD_ID         
                ,PROD_NAME
                ,PROD_INTRO
                ,PROD_INFO
                ,PROD_PRICE
                ,PROD_EXNUM
                ,PR_CLASS_LG
                ,PR_CLASS_MD
                ,EVENT_ID
                ,FILE_PATH
                ,FILE_UPNAME
                ,FILE_NAME
                   , (SELECT ROUND(AVG(B.BD_RATING),2) FROM BOARD B WHERE B.PROD_ID = P.PROD_ID) BD_RATING
              FROM  prod P
            ) TBL0
            WHERE TBL0.BD_RATING IS NOT NULL
            ORDER BY TBL0.BD_RATING DESC
          )a
            WHERE PR_CLASS_LG=#{category}
        )
WHERE rn &lt;= #{wantNum}
</select>

<!-- 	아 이 디 : getListBestProd
	  		반 환 값 : prodVo
	  		매개변수 : 없음
	  		설    명 : 베스트 상품 전체
	  		작 성 자 : 조종원
	  		일    시 : 2018-09-10     
	 -->
<select id="getListBestProd" resultType="prodVo" parameterType="Map">
		SELECT *
		FROM (
		        SELECT   T.PROD_ID
		                ,T.PROD_NAME
		                ,T.PROD_PRICE
                    ,T.FILE_PATH
                    ,T.FILE_UPNAME
		                ,ROWNUM RN
		        FROM (
		                SELECT   P.PROD_ID
		                        ,P.PROD_NAME
		                        ,P.PROD_PRICE
                            ,P.FILE_PATH
                            ,P.FILE_UPNAME
		                        ,SUM(BD_RATING) AS BD_RATING
		                FROM PROD  P
		                JOIN BOARD B
		                ON P.PROD_ID = B.PROD_ID
		                GROUP BY P.PROD_ID, P.PROD_NAME, P.PROD_PRICE ,P.FILE_PATH ,P.FILE_UPNAME
		                ORDER BY BD_RATING DESC
		              )T
		      )
		WHERE rn BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}
	
</select>

<!-- 카테고리 별 제품 리스트 조회  -->
<select id="getListCtgyBestProdList" parameterType="Map" resultType="prodVo">
	SELECT *
	FROM (
	        SELECT  T.PROD_ID
                   ,T.PROD_NAME
                   ,T.PROD_PRICE
                   ,T.FILE_PATH
                   ,T.FILE_UPNAME
                   , ROWNUM RN
	        FROM (
	                SELECT   P.PROD_ID
	                        ,P.PROD_NAME
	                        ,P.PROD_PRICE
	                        ,P.FILE_PATH
	                        ,P.FILE_UPNAME
	                        ,SUM(BD_RATING) AS BD_RATING
	                FROM PROD  P
	                JOIN BOARD B
	                ON P.PROD_ID = B.PROD_ID
	                WHERE ${pr_class}=#{pr_class_id}
	                GROUP BY P.PROD_ID, P.PROD_NAME, P.PROD_PRICE ,P.FILE_PATH ,P.FILE_UPNAME
	                ORDER BY BD_RATING DESC
	              )T
	      )
	WHERE RN BETWEEN (#{page}-1)*#{pageSize}+1 AND #{page}*#{pageSize}

</select>

<!-- 전체 상품 갯수 -->
<select id="totalCountProd" resultType="Integer">
	select count(*) from prod
</select>



<!-- 	아 이 디 : getListBestProd
  		반 환 값 : prodVo
  		매개변수 : map : 가격,  카테고리, 제목
  		설    명 : 베스트 상품 전체
  		작 성 자 : 조종원
  		일    시 : 2018-09-11    
-->
<select id="getListBestSearchProd" resultType="prodVo" parameterType="map">
SELECT  *
FROM (
        SELECT   T.*
                ,ROWNUM RN
        FROM (
              SELECT   P.PROD_ID
                      ,P.PROD_NAME
                      ,P.FILE_PATH
                      ,P.FILE_UPNAME
                      ,P.PROD_PRICE
                      ,SUM(B.BD_RATING) AS TOT
              FROM PROD P
              JOIN BOARD  B
              ON   P.PROD_ID = B.PROD_ID
              WHERE 
              		<if test="category == ''">
              			1=1
              		</if>
              	<if test="category != ''">
	                    P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{mealChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{iceChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{foodChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{drinkChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{biscuitChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{necessitiesChk}))
                </if>
              AND B.BD_KIND_ID = '55'
                
                AND P.PROD_PRICE  BETWEEN  #{min_price} AND #{max_price}
                AND P.PROD_NAME  LIKE '%'|| #{prodName}  ||'%'
              GROUP BY P.PROD_ID ,P.PROD_NAME ,P.FILE_PATH ,P.FILE_UPNAME ,P.PROD_PRICE
              ORDER BY TOT DESC
        )T
)
WHERE rn BETWEEN (#{page}-1) * #{pageSize}+1 AND #{page} * #{pageSize}
</select>

<!-- 	아 이 디 : getListBestProd
  		반 환 값 : prodVo
  		매개변수 : map : 가격,  카테고리, 제목
  		설    명 : 전체 또는 이벤트 상품 전체
  		작 성 자 : 조종원
  		일    시 : 2018-09-11    
-->
<select id="getListAllSearchProd" resultType="prodVo" parameterType="map">
SELECT  *
FROM (
        SELECT   T.*
                ,ROWNUM RN
        FROM (
              SELECT   P.PROD_ID
                      ,P.PROD_NAME
                      ,P.FILE_PATH
                      ,P.FILE_UPNAME
                      ,P.PROD_PRICE
              FROM PROD P
              WHERE 
           		<if test="category == ''">
           			1=1
           		</if>
              	<if test="category != ''">
	                    P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{mealChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{iceChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{foodChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{drinkChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{biscuitChk}))
	                OR  P.PR_CLASS_LG = ( SELECT CTGY_ID AS PR_CLASS_LG FROM   CATEGORY WHERE CTGY_NAME = (#{necessitiesChk}))
                </if>
                <if test="event_id == '200'">
	            	AND EVENT_ID = '200'
	            </if>
	            <if test="event_id != '200'">
	            	AND EVENT_ID != '200'
	            </if>
	            
                AND P.PROD_PRICE  BETWEEN  #{min_price} AND #{max_price}
                AND P.PROD_NAME  LIKE '%'|| #{prodName}  ||'%'
              GROUP BY P.PROD_ID ,P.PROD_NAME ,P.FILE_PATH ,P.FILE_UPNAME ,P.PROD_PRICE
              ORDER BY P.PROD_ID
        )T
)
WHERE rn BETWEEN (#{page}-1) * #{pageSize}+1 AND #{page} * #{pageSize}
</select>






</mapper>